#!/bin/bash

# Usage: ./analysis <cleaned_file>
# Answers 4 analysis questions from cleaned board game data

if [[ $# -ne 1 ]]; then
    echo "Usage: $0 <cleaned_file>" >&2
    exit 1
fi

input="$1"

# 1. Most popular game mechanic
echo "Calculating most popular mechanic..."
cut -f13 "$input" | grep -v "^$" | tr ',' '\n' | sed 's/^ *//;s/ *$//' | sort | uniq -c | sort -nr | head -1 | \
awk '{ count = $1; $1 = ""; sub(/^ +/, ""); print "The most popular game mechanics is " $0 " found in " count " games" }'

# 2. Most popular game domain
echo "Calculating most popular domain..."
cut -f14 "$input" | grep -v "^$" | tr ',' '\n' | sed 's/^ *//;s/ *$//' | sort | uniq -c | sort -nr | head -1 | \
awk '{ count = $1; $1 = ""; sub(/^ +/, ""); print "The most game domain is " $0 " found in " count " games" }'

# 3. Correlation: Year Published vs Rating Average
echo "Calculating correlation between year and rating..."
awk -F"\t" '
    NR > 1 && $3 ~ /^-?[0-9]+$/ && $9 ~ /^[0-9.]+$/ {
        x = $3 + 0
        y = $9 + 0
        sumx += x; sumy += y
        sumxy += x * y
        sumx2 += x * x
        sumy2 += y * y
        n++
    }
    END {
        num = n * sumxy - sumx * sumy
        den = sqrt((n * sumx2 - sumx^2) * (n * sumy2 - sumy^2))
        if (den == 0) {
            print "The correlation between the year of publication and the average rating is undefined"
        } else {
            printf "The correlation between the year of publication and the average rating is %.3f\n", num / den
        }
    }
' "$input"

# 4. Correlation: Complexity vs Rating Average
echo "Calculating correlation between complexity and rating..."
awk -F"\t" '
    NR > 1 && $11 ~ /^[0-9.]+$/ && $9 ~ /^[0-9.]+$/ {
        x = $11 + 0
        y = $9 + 0
        sumx += x; sumy += y
        sumxy += x * y
        sumx2 += x * x
        sumy2 += y * y
        n++
    }
    END {
        num = n * sumxy - sumx * sumy
        den = sqrt((n * sumx2 - sumx^2) * (n * sumy2 - sumy^2))
        if (den == 0) {
            print "The correlation between the complexity of a game and its average rating is undefined"
        } else {
            printf "The correlation between the complexity of a game and its average rating is %.3f\n", num / den
        }
    }
' "$input"

