#!/bin/bash

input="bgg_dataset.txt"
output="cleaned_output.tsv"

# Step 1: Find the max existing numeric ID
max_id=$(awk -F";" 'NR > 1 && $1 ~ /^[0-9]+$/ && $1+0 > max { max = $1+0 } END { print max+1 }' "$input")

# Step 2: Clean and output
awk -v FS=";" -v OFS="\t" -v start_id="$max_id" '
BEGIN {
    new_id = start_id
}
NR == 1 {
    # Print header as-is (converted to tab-separated below)
    for (i = 1; i <= NF; i++) headers[i] = $i
    print
    next
}
{
    # Exclude row if ID is non-empty but non-numeric
    if ($1 != "" && $1 !~ /^[0-9]+$/) next

    # Generate ID if missing
    if ($1 == "") $1 = new_id++

    # Convert decimal commas to dots
    gsub(",", ".", $9)
    gsub(",", ".", $11)

    # Remove non-ASCII characters from all fields
    for (i = 1; i <= NF; i++) {
        gsub(/[^\t -~]/, "", $i)
    }

    print $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14
}
' "$input" | tr ';' '\t' | sed 's/\r$//' > "$output"

