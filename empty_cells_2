#!/bin/bash

# Usage: ./empty_cells <file> <separator>
# Example: ./empty_cells absurd1.txt ";"

if [[ $# -ne 2 ]]; then
    echo "Usage: $0 <file> <separator>" >&2
    exit 1
fi

file="$1"
sep="$2"

# Check if the file exists and is readable
if [[ ! -f "$file" || ! -r "$file" ]]; then
    echo "Error: File '$file' does not exist or is not readable." >&2
    exit 1
fi

# Process the file using awk
awk -v FS="$sep" '
NR == 1 {
    # Process header line - store column titles
    for (i = 1; i <= NF; i++) {
        headers[i] = $i
        empty_count[i] = 0
    }
    col_count = NF
    next
}

# Skip completely blank lines
NF == 0 { next }

{
    # Process data rows
    for (i = 1; i <= NF; i++) {
        # Trim leading/trailing whitespace
        gsub(/^[ \t]+|[ \t]+$/, "", $i)
        
        # Check if field is empty
        if ($i == "" || $i == "\"\"") {
            empty_count[i]++
        }
    }
    
    # Handle rows with fewer fields than header
    if (NF < col_count) {
        for (i = NF + 1; i <= col_count; i++) {
            empty_count[i]++
        }
    }
}

END {
    # Output results
    for (i = 1; i <= col_count; i++) {
        print headers[i] ": " empty_count[i]
    }
}
' "$file"
